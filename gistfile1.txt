
###########################
### RUN ON YOUR MACHINE ###
###########################

## Install qemu-static
dnf install qemu-user-static
systemctl restart systemd-binfmt


## Mount the rootfs
parted sd-blob-b01.img
> unit B
> p

 - Take note of the start position of the rootfs

mount -o loop,offset=12582912 sd-blob-b01.img /mnt
cd /mnt

## Chroot

mount -t proc proc proc/
mount -t sysfs sysfs sys/
mount -t devtmpfs devtmpfs dev/

chroot ./

##############################
### RUN ON THE JETSON ROOTFS #
##############################

echo "nameserver 8.8.8.8 > /etc/resolv.conf"

mkdir /usr/lib/ubiquity/plugins.disabled
mv /usr/lib/ubiquity/plugins/nvlicense.py /usr/lib/ubiquity/plugins/ubi-usersetup.py /usr/lib/ubiquity/plugins.disabled/

## Prepare debconf:
cat <<EOF >/preseed.cfg
d-i debian-installer/locale string en_DK.UTF-8
d-i keyboard-configuration/xkb-keymap select fi
d-i keyboard-configuration/layoutcode string fi
d-i keyboard-configuration/variantcode string
d-i time/zone string Europe/Helsinki
EOF

mkdir /etc/systemd/system/nv-oem-config-gui.service.d

cat <<EOF >//etc/systemd/system/nv-oem-config-gui.service.d/auto.conf
[Service]
# Override ExecStart
ExecStart=/bin/sh -ec '\
    debconf-set-selections /preseed.cfg; \
    exec nv-oem-config-firstboot --automatic'
EOF

## Software
apt update
apt upgrade
apt install python3-pip git libjpeg-dev libhdf5-dev libfreetype6-dev
pip3 install virtualenvwrapper

## Jetson user

useradd -m -G sudo -s /bin/bash jetson
echo "jetson:jetson" | chpasswd

su - jetson


## Virtualenv

echo "export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3" >> .bashrc
echo "source /usr/local/bin/virtualenvwrapper.sh" >> .bashrc
source .bashrc

mkvirtualenv donkey1
echo "workon donkey1" >> .bashrc
source .bashrc

## Install donkeycar

cd
git clone https://github.com/castortut/donkeycar.git
cd donkeycar
git checkout master

pip install -e .[nano]
pip install --extra-index-url https://developer.download.nvidia.com/compute/redist/jp/v42 tensorflow-gpu==1.14.0+nv19.9
pip install matplotlib

## Download mycar
cd
git clone https://github.com/castortut/donkey_mycar.git mycar; 
cd mycar